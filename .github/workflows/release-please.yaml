name: Release Please

on:
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write

jobs:
  release-please:
    runs-on: ubuntu-latest
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
    steps:
      - uses: google-github-actions/release-please-action@v4
        id: release
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          release-type: go
          package-name: imds-credential-server
          config-file: release-please-config.json
          manifest-file: .release-please-manifest.json

  # Build and release only if a release was created
  build-binaries:
    needs: release-please
    if: ${{ needs.release-please.outputs.release_created }}
    name: Release Go Binary
    runs-on: ubuntu-latest
    strategy:
      matrix:
        # build and publish in parallel: linux/amd64, linux/arm64, windows/amd64, darwin/amd64, darwin/arm64
        goos: [linux, windows, darwin]
        goarch: [amd64, arm64]
        exclude:
          - goarch: arm64
            goos: windows
    steps:
      - uses: actions/checkout@v4
      - uses: wangyoucao577/go-release-action@v1.38
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          goos: ${{ matrix.goos }}
          goarch: ${{ matrix.goarch }}
          extra_files: LICENSE README.md
          compress_assets: "true"
          md5sum: "false"
          upload_url: ${{ needs.release-please.outputs.upload_url }}

  ko-build:
    needs: release-please
    if: ${{ needs.release-please.outputs.release_created }}
    name: Build and Push Container Images
    runs-on: ubuntu-latest
    permissions:
      contents: write # For uploading release assets
      packages: write # For publishing container images to ghcr.io
      id-token: write # For OIDC token for signing and attestations
      attestations: write # For creating attestations
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.19"

      - name: Setup ko
        uses: ko-build/setup-ko@v0.6

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push container images
        id: build
        env:
          KO_DOCKER_REPO: ghcr.io/${{ github.repository }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Extract version from tag
          VERSION="${{ needs.release-please.outputs.tag_name }}"

          # Build and push multi-architecture images
          ko build --bare \
            --platform=linux/amd64,linux/arm64 \
            --tags="${VERSION},latest" \
            --image-refs=image-refs.txt \
            ./

          # Display the published image references
          echo "Published images:"
          cat image-refs.txt

          # Extract image reference and digest for attestation steps
          IMAGE_REF=$(head -n1 image-refs.txt)
          echo "image=${IMAGE_REF}" >> $GITHUB_OUTPUT

          # Extract digest (everything after @)
          DIGEST=$(echo "$IMAGE_REF" | cut -d'@' -f2)
          echo "digest=${DIGEST}" >> $GITHUB_OUTPUT

      - name: Generate SBOM files
        run: |
          IMAGE_REF=$(head -n1 image-refs.txt)

          # Generate SPDX SBOM (GitHub's preferred format)
          ko sbom ${IMAGE_REF} --sbom=spdx > sbom.spdx.json

          # Generate CycloneDX SBOM for broader compatibility
          ko sbom ${IMAGE_REF} --sbom=cyclonedx > sbom.cyclonedx.json

      - name: Attest SBOM
        uses: actions/attest-sbom@v1
        with:
          subject-name: ghcr.io/${{ github.repository }}
          subject-digest: ${{ steps.build.outputs.digest }}
          sbom-path: sbom.spdx.json
          push-to-registry: true

      - name: Generate build provenance attestation
        uses: actions/attest-build-provenance@v1
        with:
          subject-name: ghcr.io/${{ github.repository }}
          subject-digest: ${{ steps.build.outputs.digest }}
          push-to-registry: true

      - name: Upload SBOM to GitHub Dependency Graph
        uses: advanced-security/spdx-dependency-submission-action@v0.1.1
        with:
          filePath: sbom.spdx.json

      - name: Install Cosign
        uses: sigstore/cosign-installer@v3

      - name: Sign container image
        env:
          COSIGN_EXPERIMENTAL: 1
        run: |
          IMAGE_REF=$(head -n1 image-refs.txt)
          cosign sign --yes ${IMAGE_REF}

      - name: Upload SBOMs to release assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.release-please.outputs.tag_name }}
          files: |
            sbom.spdx.json
            sbom.cyclonedx.json

      - name: Upload image references as artifact
        uses: actions/upload-artifact@v4
        with:
          name: container-image-refs
          path: image-refs.txt
